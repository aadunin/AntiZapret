name: Build Mikrotik RSC

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Клонируем репозиторий и сохраняем креды для пуша
      - uses: actions/checkout@v3
        with:
          persist-credentials: true   # важно, чтобы был доступ на push

      # 2) Скачиваем оригинальный hosts
      - name: Fetch original hosts
        run: |
          curl -sSL -o hosts \
            https://raw.githubusercontent.com/pumPCin/AntiZapret/main/hosts

      # 3) Генерируем Mikrotik-скрипт
      - name: Generate update-hosts.rsc
        run: |
          mkdir -p mikrotik
          echo "/ip dns static remove [find comment=\"autohost\"]" \
            > mikrotik/update-hosts.rsc

          cnt=0
          while read -r ip rest; do
            for d in $rest; do
              echo "/ip dns static add name=$d address=$ip ttl=1d comment=\"autohost\"" \
                >> mikrotik/update-hosts.rsc
              cnt=$((cnt+1))
            done
          done < <(grep -Ev '^(#|$)' hosts)

          echo "/log info \"[update-hosts] Added $cnt entries\"" \
            >> mikrotik/update-hosts.rsc

          echo ":: Generated $cnt entries"

      # 4) Коммитим и пушим mikrotik/update-hosts.rsc в ваш форк
      - name: Commit & Push update-hosts.rsc
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add mikrotik/update-hosts.rsc
          git diff --quiet --cached || git commit -m "Rebuild Mikrotik RSC: $cnt entries"
          git push
